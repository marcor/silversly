{% extends "product/main.html" %}

{% block title %}Aggiungi una fornitura{% endblock %}

{% block header %}
    <h1>Aggiungi una fornitura</h1>
{% endblock %}

{% block jquery %}
	{{block.super}}
        var supplier_id;
        
        check_supplier(); 
        {% if products %}
	$("#id_supplier").attr("disabled", true);
	$("#products").trigger("focus");
        {% else %}
          $("#id_supplier").trigger("focus");
        {% endif %}	
        
        function check_supplier() { 
            supplier_id = $("#id_supplier").val();
            if (supplier_id != "") {
	    $("#search_bar").show();
	    $("#products").trigger("focus");
            }
            else {
	    $("#search_bar").hide();
            };
        };
	
        $("#id_supplier").change(function() {
            check_supplier();    
        });
	
        function updateList(productRow) {
            var pid = $(productRow).attr("id");
	   var existing =  $("tr#" + pid);
	   if (existing.length > 0) 
		{ existing.replaceWith(productRow) }
	   else { 
	          $("#product_list>tbody").append(productRow);
		$("#id_supplier").attr("disabled", true);
		$("#product_list").show();
		$("#save").show();
	   }; 
	   
        };
        
        $("#baseform").change(function() {
            $.post("{% url show_batch_load batch.pk %}",
                  $("#baseform").serialize()
	   );
            return false;
        });
	
        $("#baseform").submit(function () { return false; });

        function showNothing() {
            $("#message").show();            
        }

	function editPricesAndAdd(pk) {
		 $.get("",
                    function(resultForm) {
                        $("#prices_dialog").dialog({
                           'draggable': false,
                           'resizable': false,
                           'modal': true,
                           'open': function() { $(this).html(resultForm); }
                        })
		}
            );
            return false;
	}
	
        function addProductToList(pk) {
            $.get("{% url add_product_to_batch batch.pk %}",
                    {'product_pk': pk},
                    function(resultForm) {
                        $("#add_product_dialog").dialog({
                           'draggable': false,
                           'resizable': false,
                           'modal': true,
                           'open': function() { $(this).html(resultForm); }
                        })
		}
            );
            return false;
        }
	
        $("a.edit_product").live('click', function() {
	$.get($(this).attr("href"),
                    {},
                    function(resultForm) {
                        $("#add_product_dialog").dialog({
                           'draggable': false,
                           'resizable': false,
                           'modal': true,
                           'open': function() { $(this).html(resultForm); }
                        })
		}
            );
            return false;
	});
        
        $("#suppliers").trigger("focus");
        $( "#add,#save,#new_product" ).button();
        
        $( "#add" ).live('click', function() {
            var sell_button = $(this);
            $( "#sell_product_dialog" ).dialog({
                'draggable': false,
                'resizable': false,
                'modal': true,
                'open': function() { $(this).load(sell_button.attr('href'))}
            });
            return false;
        });
        
        $( "#products" ).autocomplete({
            source: function(request, response) {
		if ($("#search_all").attr("checked")) {
			var data = {'term': request.term}
		} else {
			var data = {'term': request.term, 'supplier':supplier_id}
		}
                $.ajax({
                    "url": "{% url ajax_find_product %}",
                    "data": data,
                    "dataType": "json",
                    "success": function(results) {
                        if (results.length > 0) { 
                            response(results);
                        } else {
                            response(results);
                            showNothing();                            
                        }
                    }
                });
            },
            minLength: 3,
            search: function(event, ui) {
                $("#message").hide();
            },
            focus: function( event, ui ) {
                /*$( "#products" ).val( ui.item.fields.name );*/
                return false;
            },
            select: function( event, ui ) {
                /*$( "#products" ).val( ui.item.fields.name );*/
                if (ui.item) {
                    addProductToList(ui.item.pk);
                }
                return false;
	}
		}).data( "autocomplete" )._renderItem = function( ul, item ) {
            return $( "<li></li>" )
                .data( "item.autocomplete", item )
                .append( "<a>" + item.fields.name + "<br/><span class=\"searchcode\">" + item.fields.code + "</span></a>" )
                .appendTo( ul );
        };
	
	
	
	$( "#add_product" ).live('click', function() {
            var form = $( "#add_product_form" );
            $.ajax({
                "url": form.attr("action"),
                "type": "POST",
                "data": form.serialize(),
                "complete": function(xhr, status) {
                    if (status == "success") {
                        $( "#add_product_dialog" ).dialog("close");
		     updateList(xhr.responseText);                                                
                    } else {
                        $("#add_product_dialog").html(xhr.responseText);                    
                    };
                }
            });
            return false;
        });
	
	 $( "#new_product" ).live('click', function() {
            $( "#new_product_dialog" ).dialog({
                'draggable': false,
                'resizable': false,
                'modal': true,
                'open': function() { $(this).load("{% url add_product %}")}
            });
            return false;
        });
	
	$( "#save_new_product" ).live('click', function() {
            var form = $( "#new_product_form" );
            $.ajax({
                "url": "{% url add_product %}",
                "type": "POST",
                "data": form.serialize(),
                "complete": function(xhr, status) {
                    if (status == "success") {
                        $( "#new_product_dialog" ).dialog("close");
			addProductToList(xhr.responseText);		     
                    } else {
                        $("#new_product_dialog").html(xhr.responseText);                    
                    };
                }
            });
            return false;
        });
{% endblock %}

{% block content %}

    <form id="baseform" action="" method="post">
	{{ base_form.as_p }}
    </form>
    
    <div class="framed">
    
    <div id="search_bar">
	<span>Cerca:</span>
        <input id="products" />
	<input type="checkbox" id="search_all" title="Cerca tutti gli articoli (anche quelli forniti da altri)"/>
	<a id="new_product" href="#" />Nuovo articolo</a>
    </div>
    
    <div id="message" style="display:none">Nessun risultato</div>
    
    <table id="product_list" {% if not products %}style="display:none"{% endif %}>
	<thead>
		<tr>
			<td>Cod. fornitore</td>
			<td>Nome</td>
			<td>Quantit&agrave;</td>
			<td>Prezzo</td>
		</tr>
	</thead>
	<tbody>
		{% for item in products %}
			{% include  "batch_load/product_row.html" %}
		{% endfor %}
	</tbody>
    </table>
    </div>
    
    <a id="save" href="{% url save_batch_load batch.id %}" {% if not products %}style="display: none"{% endif %}>Carica tutto</a>
        
    
    <div id="add_product_dialog" title="Carica un prodotto" class="dialog"></div>
    <div id="new_product_dialog" title="Crea un articolo" class="dialog"></div>
    
{% endblock %}

        
